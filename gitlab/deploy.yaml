.base:
  &base
  stage: deploy

.deploy:
  <<: *base
  variables:
    ENVIRONMENT: "this needs to be set"
  before_script:
    - echo "A hacky way to override global before_script to avoid failure"
  script:
    - echo "deploying to ${ENVIRONMENT}" # using as a placeholder

release:
  <<: *base
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  release:
     name: 'Release $CI_COMMIT_TAG'
     description: Created from CI/CD pipeline
     tag_name: '$CI_COMMIT_TAG'
     ref: '$CI_COMMIT_TAG'
  script:
    - echo "Releasing..."

deploy-to-isolated-staging:
  extends: .deploy
  variables:
    ENVIRONMENT: $GITLAB_USER_EMAIL
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /feature/'

deploy-to-staging:
  extends: .deploy
  variables:
    ENVIRONMENT: staging
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy-to-production:
  extends: .deploy
  variables:
    ENVIRONMENT: production
  rules:
    - if: $CI_COMMIT_TAG

