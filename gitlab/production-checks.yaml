.base:
  &base
  extends: .common
  stage: production-checks
  image: $PRODUCTION_CONTAINER_IMAGE
  needs:
    - build-production-container

integration-test:
  <<: *base
  services:
    - name: postgres:13.0
      alias: database
  variables:
    DATABASE_HOST: database
    DATABASE_PORT: 5432
    POSTGRES_DB: porter_pipeline
    POSTGRES_USER: porter_app
    POSTGRES_PASSWORD: password
  script:
    - pwd
    - ls -la
    - pip install coverage unittest-xml-reporting
    - scripts/test_app/run_integration_tests.sh
    - coverage xml
    - coverage report
  after_script:
    - pwd
    - ls -la
    - cp $APP_DIR/coverage.xml $CI_PROJECT_DIR/.
    - cp $APP_DIR/test.xml $CI_PROJECT_DIR/.
  artifacts:
    reports:
      cobertura: coverage.xml
      junit: test.xml
    when: always

