.base:
  &base
  needs:
    - build-development-container
  stage: development-checks
  image: $DEVELOPMENT_CONTAINER_IMAGE
  before_script:
    - cd $APP_DIR
    - ls -la

unit-test:
  <<: *base
  extends:
    - .database # database is needed to run unit test suite,
    # but database is not used in unit test suite
    - .cache-coverage
  script:
    - scripts/test_app/run_unit_tests.sh
    - scripts/test_app/fill_coverage_gaps.sh
    - coverage report
  after_script:
    - cp $APP_DIR/.coverage $CI_PROJECT_DIR/.
    - cp $APP_DIR/$ARTIFACTS_DIR/test.xml $CI_PROJECT_DIR/$ARTIFACTS_DIR/.
  cache:
    policy: push
  artifacts:
    reports:
      junit: $ARTIFACTS_DIR/test.xml

lint-shell-scripts:
  <<: *base
  image: koalaman/shellcheck-alpine:v0.7.1
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - ls -la
  script:
    - scripts/lint_app/run_shellcheck.sh

lint-python-code-with-pycodestyle:
  <<: *base
  script:
    - scripts/lint_app/run_pycodestyle.sh

lint-python-code-with-pylint:
  <<: *base
  script:
    - scripts/lint_app/run_pylint.sh
  variables: !reference [.database, variables] # needed to run linter, but is
    # not used to connect to database

document:
  <<: *base
  extends:
    - .database # database is needed to build documentation,
    # but database is not used while building documentation
    - .cache-document
  script:
    - scripts/document_app.sh
    - pwd
    - ls -la
    - mkdir --parents ${CI_PROJECT_DIR}/${ARTIFACTS_DIR}/${GITLAB_PAGES_FOLDER}/docs/
    - ls -la  ${CI_PROJECT_DIR}
    - ls -la  ${CI_PROJECT_DIR}/${ARTIFACTS_DIR}
    - cp --recursive ${APP_DIR}/docs/build/ ${CI_PROJECT_DIR}/${ARTIFACTS_DIR}/docs/
  cache:
    policy: push
  artifacts:
    paths:
      - ${ARTIFACTS_DIR}/docs/

