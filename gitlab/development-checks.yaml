.base:
  &base
  needs:
    - build-development-container
  stage: development-checks
  image: $DEVELOPMENT_CONTAINER_IMAGE
  before_script:
    - cd $APP_DIR
    - ls -la

unit-test:
  <<: *base
  extends:
    - .cache-coverage
  ### test database needed to run test suite, but used in unit tests
  services:
    - name: postgres:13.0
      alias: database
  variables:
    DATABASE_HOST: database
    DATABASE_PORT: 5432
    POSTGRES_DB: porter_pipeline
    POSTGRES_USER: porter_app
    POSTGRES_PASSWORD: password
  ###:end test database needed to run test suite, but used in unit tests
  script:
    - scripts/test_app/run_unit_tests.sh
    - scripts/test_app/fill_coverage_gaps.sh
    - coverage report
  after_script:
    - cp $APP_DIR/.coverage $CI_PROJECT_DIR/.
    - cp $APP_DIR/test.xml $CI_PROJECT_DIR/.
  cache:
    policy: push
  artifacts:
    reports:
      junit: test.xml
    when: always

lint-shell-scripts:
  <<: *base
  script:
    - scripts/lint_app/run_shellcheck.sh

lint-python-code-with-pycodestyle:
  <<: *base
  script:
    - scripts/lint_app/run_pycodestyle.sh

lint-python-code-with-pylint:
  <<: *base
  script:
    - scripts/lint_app/run_pylint.sh
  variables:
    DATABASE_HOST: not_used_to_connect_to_database # needed to run linter
    DATABASE_PORT: not_used_to_connect_to_database # needed to run linter
    POSTGRES_DB: not_used_to_connect_to_database # needed to run linter
    POSTGRES_USER: not_used_to_connect_to_database # needed to run linter
    POSTGRES_PASSWORD: not_used_to_connect_to_database # needed to run linter

document:
  <<: *base
  script:
    - scripts/document_app.sh
    - cp -r docs/build/ /builds/porter4/backend/.
  artifacts:
    paths:
      - build/

